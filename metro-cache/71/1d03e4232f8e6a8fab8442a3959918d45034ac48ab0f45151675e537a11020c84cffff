{"dependencies":[{"name":"noop-fn","data":{"isAsync":false}},{"name":"tiny-queue","data":{"isAsync":false}},{"name":"immediate","data":{"isAsync":false}},{"name":"./WebSQLResultSet","data":{"isAsync":false}}],"output":[{"data":{"code":"__d(function (global, _$$_REQUIRE, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  'use strict';\n\n  var noop = _$$_REQUIRE(_dependencyMap[0], \"noop-fn\");\n\n  var Queue = _$$_REQUIRE(_dependencyMap[1], \"tiny-queue\");\n\n  var immediate = _$$_REQUIRE(_dependencyMap[2], \"immediate\");\n\n  var WebSQLResultSet = _$$_REQUIRE(_dependencyMap[3], \"./WebSQLResultSet\");\n\n  function errorUnhandled() {\n    return true;\n  }\n\n  function massageSQLResult(sql, insertId, rowsAffected, rows) {\n    if (/^\\s*UPDATE\\b/i.test(sql)) {\n      insertId = void 0;\n    } else if (/^\\s*CREATE\\s+TABLE\\b/i.test(sql)) {\n      insertId = 0;\n      rowsAffected = 0;\n    } else if (/^\\s*DROP\\s+TABLE\\b/i.test(sql)) {\n      insertId = void 0;\n      rowsAffected = 0;\n    } else if (!/^\\s*INSERT\\b/i.test(sql)) {\n      insertId = void 0;\n    }\n\n    return new WebSQLResultSet(insertId, rowsAffected, rows);\n  }\n\n  function SQLTask(sql, args, sqlCallback, sqlErrorCallback) {\n    this.sql = sql;\n    this.args = args;\n    this.sqlCallback = sqlCallback;\n    this.sqlErrorCallback = sqlErrorCallback;\n  }\n\n  function runBatch(self, batch) {\n    function onDone() {\n      self._running = false;\n      runAllSql(self);\n    }\n\n    var readOnly = self._websqlDatabase._currentTask.readOnly;\n\n    self._websqlDatabase._db.exec(batch, readOnly, function (err, results) {\n      if (err) {\n        self._error = err;\n        return onDone();\n      }\n\n      for (var i = 0; i < results.length; i++) {\n        var res = results[i];\n        var batchTask = batch[i];\n\n        if (res.error) {\n          if (batchTask.sqlErrorCallback(self, res.error)) {\n            self._error = res.error;\n            return onDone();\n          }\n        } else {\n          batchTask.sqlCallback(self, massageSQLResult(batch[i].sql, res.insertId, res.rowsAffected, res.rows));\n        }\n      }\n\n      onDone();\n    });\n  }\n\n  function runAllSql(self) {\n    if (self._running || self._complete) {\n      return;\n    }\n\n    if (self._error || !self._sqlQueue.length) {\n      self._complete = true;\n      return self._websqlDatabase._onTransactionComplete(self._error);\n    }\n\n    self._running = true;\n    var batch = [];\n    var task;\n\n    while (task = self._sqlQueue.shift()) {\n      batch.push(task);\n    }\n\n    runBatch(self, batch);\n  }\n\n  function executeSql(self, sql, args, sqlCallback, sqlErrorCallback) {\n    self._sqlQueue.push(new SQLTask(sql, args, sqlCallback, sqlErrorCallback));\n\n    if (self._runningTimeout) {\n      return;\n    }\n\n    self._runningTimeout = true;\n    immediate(function () {\n      self._runningTimeout = false;\n      runAllSql(self);\n    });\n  }\n\n  function WebSQLTransaction(websqlDatabase) {\n    this._websqlDatabase = websqlDatabase;\n    this._error = null;\n    this._complete = false;\n    this._runningTimeout = false;\n    this._sqlQueue = new Queue();\n\n    if (!websqlDatabase._currentTask.readOnly) {\n      this._sqlQueue.push(new SQLTask('BEGIN;', [], noop, noop));\n    }\n  }\n\n  WebSQLTransaction.prototype.executeSql = function (sql, args, sqlCallback, sqlErrorCallback) {\n    args = Array.isArray(args) ? args : [];\n    sqlCallback = typeof sqlCallback === 'function' ? sqlCallback : noop;\n    sqlErrorCallback = typeof sqlErrorCallback === 'function' ? sqlErrorCallback : errorUnhandled;\n    executeSql(this, sql, args, sqlCallback, sqlErrorCallback);\n  };\n\n  WebSQLTransaction.prototype._checkDone = function () {\n    runAllSql(this);\n  };\n\n  module.exports = WebSQLTransaction;\n});","map":[[2,0,1,0],[4,0,3,0],[4,6,3,4,"noop"],[4,10,3,8],[4,13,3,11,"require"],[4,24,3,18],[4,54,3,0],[6,0,4,0],[6,6,4,4,"Queue"],[6,11,4,9],[6,14,4,12,"require"],[6,25,4,19],[6,58,4,0],[8,0,5,0],[8,6,5,4,"immediate"],[8,15,5,13],[8,18,5,16,"require"],[8,29,5,23],[8,61,5,0],[10,0,6,0],[10,6,6,4,"WebSQLResultSet"],[10,21,6,19],[10,24,6,22,"require"],[10,35,6,29],[10,75,6,0],[12,0,8,0],[12,11,8,9,"errorUnhandled"],[12,25,8,0],[12,28,8,26],[13,0,9,2],[13,11,9,9],[13,15,9,2],[14,0,10,1],[16,0,17,0],[16,11,17,9,"massageSQLResult"],[16,27,17,0],[16,28,17,26,"sql"],[16,31,17,0],[16,33,17,31,"insertId"],[16,41,17,0],[16,43,17,41,"rowsAffected"],[16,55,17,0],[16,57,17,55,"rows"],[16,61,17,0],[16,63,17,61],[17,0,18,2],[17,8,18,6],[17,24,18,22,"test"],[17,28,18,6],[17,29,18,27,"sql"],[17,32,18,6],[17,33,18,2],[17,35,18,33],[18,0,20,4,"insertId"],[18,6,20,4,"insertId"],[18,14,20,12],[18,17,20,15],[18,22,20,20],[18,23,20,4],[19,0,21,3],[19,5,18,2],[19,11,21,9],[19,15,21,13],[19,39,21,37,"test"],[19,43,21,13],[19,44,21,42,"sql"],[19,47,21,13],[19,48,21,9],[19,50,21,48],[20,0,23,4,"insertId"],[20,6,23,4,"insertId"],[20,14,23,12],[20,17,23,15],[20,18,23,4],[21,0,24,4,"rowsAffected"],[21,6,24,4,"rowsAffected"],[21,18,24,16],[21,21,24,19],[21,22,24,4],[22,0,25,3],[22,5,21,9],[22,11,25,9],[22,15,25,13],[22,37,25,35,"test"],[22,41,25,13],[22,42,25,40,"sql"],[22,45,25,13],[22,46,25,9],[22,48,25,46],[23,0,28,4,"insertId"],[23,6,28,4,"insertId"],[23,14,28,12],[23,17,28,15],[23,22,28,20],[23,23,28,4],[24,0,29,4,"rowsAffected"],[24,6,29,4,"rowsAffected"],[24,18,29,16],[24,21,29,19],[24,22,29,4],[25,0,30,3],[25,5,25,9],[25,11,30,9],[25,15,30,13],[25,16,30,14],[25,32,30,30,"test"],[25,36,30,14],[25,37,30,35,"sql"],[25,40,30,14],[25,41,30,9],[25,43,30,41],[26,0,33,4,"insertId"],[26,6,33,4,"insertId"],[26,14,33,12],[26,17,33,15],[26,22,33,20],[26,23,33,4],[27,0,34,3],[29,0,35,2],[29,11,35,9],[29,15,35,13,"WebSQLResultSet"],[29,30,35,9],[29,31,35,29,"insertId"],[29,39,35,9],[29,41,35,39,"rowsAffected"],[29,53,35,9],[29,55,35,53,"rows"],[29,59,35,9],[29,60,35,2],[30,0,36,1],[32,0,38,0],[32,11,38,9,"SQLTask"],[32,18,38,0],[32,19,38,17,"sql"],[32,22,38,0],[32,24,38,22,"args"],[32,28,38,0],[32,30,38,28,"sqlCallback"],[32,41,38,0],[32,43,38,41,"sqlErrorCallback"],[32,59,38,0],[32,61,38,59],[33,0,39,2],[33,9,39,7,"sql"],[33,12,39,2],[33,15,39,13,"sql"],[33,18,39,2],[34,0,40,2],[34,9,40,7,"args"],[34,13,40,2],[34,16,40,14,"args"],[34,20,40,2],[35,0,41,2],[35,9,41,7,"sqlCallback"],[35,20,41,2],[35,23,41,21,"sqlCallback"],[35,34,41,2],[36,0,42,2],[36,9,42,7,"sqlErrorCallback"],[36,25,42,2],[36,28,42,26,"sqlErrorCallback"],[36,44,42,2],[37,0,43,1],[39,0,45,0],[39,11,45,9,"runBatch"],[39,19,45,0],[39,20,45,18,"self"],[39,24,45,0],[39,26,45,24,"batch"],[39,31,45,0],[39,33,45,31],[40,0,47,2],[40,13,47,11,"onDone"],[40,19,47,2],[40,22,47,20],[41,0,48,4,"self"],[41,6,48,4,"self"],[41,10,48,8],[41,11,48,9,"_running"],[41,19,48,4],[41,22,48,20],[41,27,48,4],[42,0,49,4,"runAllSql"],[42,6,49,4,"runAllSql"],[42,15,49,13],[42,16,49,14,"self"],[42,20,49,13],[42,21,49,4],[43,0,50,3],[45,0,52,2],[45,8,52,6,"readOnly"],[45,16,52,14],[45,19,52,17,"self"],[45,23,52,21],[45,24,52,22,"_websqlDatabase"],[45,39,52,17],[45,40,52,38,"_currentTask"],[45,52,52,17],[45,53,52,51,"readOnly"],[45,61,52,2],[47,0,54,2,"self"],[47,4,54,2,"self"],[47,8,54,6],[47,9,54,7,"_websqlDatabase"],[47,24,54,2],[47,25,54,23,"_db"],[47,28,54,2],[47,29,54,27,"exec"],[47,33,54,2],[47,34,54,32,"batch"],[47,39,54,2],[47,41,54,39,"readOnly"],[47,49,54,2],[47,51,54,49],[47,61,54,59,"err"],[47,64,54,49],[47,66,54,64,"results"],[47,73,54,49],[47,75,54,73],[48,0,56,4],[48,10,56,8,"err"],[48,13,56,4],[48,15,56,13],[49,0,57,6,"self"],[49,8,57,6,"self"],[49,12,57,10],[49,13,57,11,"_error"],[49,19,57,6],[49,22,57,20,"err"],[49,25,57,6],[50,0,58,6],[50,15,58,13,"onDone"],[50,21,58,19],[50,23,58,6],[51,0,59,5],[53,0,60,4],[53,11,60,9],[53,15,60,13,"i"],[53,16,60,14],[53,19,60,17],[53,20,60,4],[53,22,60,20,"i"],[53,23,60,21],[53,26,60,24,"results"],[53,33,60,31],[53,34,60,32,"length"],[53,40,60,4],[53,42,60,40,"i"],[53,43,60,41],[53,45,60,4],[53,47,60,45],[54,0,61,6],[54,12,61,10,"res"],[54,15,61,13],[54,18,61,16,"results"],[54,25,61,23],[54,26,61,24,"i"],[54,27,61,23],[54,28,61,6],[55,0,62,6],[55,12,62,10,"batchTask"],[55,21,62,19],[55,24,62,22,"batch"],[55,29,62,27],[55,30,62,28,"i"],[55,31,62,27],[55,32,62,6],[57,0,63,6],[57,12,63,10,"res"],[57,15,63,13],[57,16,63,14,"error"],[57,21,63,6],[57,23,63,21],[58,0,64,8],[58,14,64,12,"batchTask"],[58,23,64,21],[58,24,64,22,"sqlErrorCallback"],[58,40,64,12],[58,41,64,39,"self"],[58,45,64,12],[58,47,64,45,"res"],[58,50,64,48],[58,51,64,49,"error"],[58,56,64,12],[58,57,64,8],[58,59,64,57],[59,0,66,10,"self"],[59,12,66,10,"self"],[59,16,66,14],[59,17,66,15,"_error"],[59,23,66,10],[59,26,66,24,"res"],[59,29,66,27],[59,30,66,28,"error"],[59,35,66,10],[60,0,67,10],[60,19,67,17,"onDone"],[60,25,67,23],[60,27,67,10],[61,0,68,9],[62,0,69,7],[62,9,63,6],[62,15,69,13],[63,0,70,8,"batchTask"],[63,10,70,8,"batchTask"],[63,19,70,17],[63,20,70,18,"sqlCallback"],[63,31,70,8],[63,32,70,30,"self"],[63,36,70,8],[63,38,70,36,"massageSQLResult"],[63,54,70,52],[63,55,71,10,"batch"],[63,60,71,15],[63,61,71,16,"i"],[63,62,71,15],[63,63,71,10],[63,64,71,19,"sql"],[63,67,70,52],[63,69,71,24,"res"],[63,72,71,27],[63,73,71,28,"insertId"],[63,81,70,52],[63,83,71,38,"res"],[63,86,71,41],[63,87,71,42,"rowsAffected"],[63,99,70,52],[63,101,71,56,"res"],[63,104,71,59],[63,105,71,60,"rows"],[63,109,70,52],[63,110,70,8],[64,0,72,7],[65,0,73,5],[67,0,74,4,"onDone"],[67,6,74,4,"onDone"],[67,12,74,10],[68,0,75,3],[68,5,54,2],[69,0,76,1],[71,0,78,0],[71,11,78,9,"runAllSql"],[71,20,78,0],[71,21,78,19,"self"],[71,25,78,0],[71,27,78,25],[72,0,79,2],[72,8,79,6,"self"],[72,12,79,10],[72,13,79,11,"_running"],[72,21,79,6],[72,25,79,23,"self"],[72,29,79,27],[72,30,79,28,"_complete"],[72,39,79,2],[72,41,79,39],[73,0,80,4],[74,0,81,3],[76,0,82,2],[76,8,82,6,"self"],[76,12,82,10],[76,13,82,11,"_error"],[76,19,82,6],[76,23,82,21],[76,24,82,22,"self"],[76,28,82,26],[76,29,82,27,"_sqlQueue"],[76,38,82,22],[76,39,82,37,"length"],[76,45,82,2],[76,47,82,45],[77,0,83,4,"self"],[77,6,83,4,"self"],[77,10,83,8],[77,11,83,9,"_complete"],[77,20,83,4],[77,23,83,21],[77,27,83,4],[78,0,84,4],[78,13,84,11,"self"],[78,17,84,15],[78,18,84,16,"_websqlDatabase"],[78,33,84,11],[78,34,84,32,"_onTransactionComplete"],[78,56,84,11],[78,57,84,55,"self"],[78,61,84,59],[78,62,84,60,"_error"],[78,68,84,11],[78,69,84,4],[79,0,85,3],[81,0,86,2,"self"],[81,4,86,2,"self"],[81,8,86,6],[81,9,86,7,"_running"],[81,17,86,2],[81,20,86,18],[81,24,86,2],[82,0,87,2],[82,8,87,6,"batch"],[82,13,87,11],[82,16,87,14],[82,18,87,2],[83,0,88,2],[83,8,88,6,"task"],[83,12,88,2],[85,0,89,2],[85,11,89,10,"task"],[85,15,89,14],[85,18,89,17,"self"],[85,22,89,21],[85,23,89,22,"_sqlQueue"],[85,32,89,17],[85,33,89,32,"shift"],[85,38,89,17],[85,40,89,2],[85,42,89,42],[86,0,90,4,"batch"],[86,6,90,4,"batch"],[86,11,90,9],[86,12,90,10,"push"],[86,16,90,4],[86,17,90,15,"task"],[86,21,90,4],[87,0,91,3],[89,0,92,2,"runBatch"],[89,4,92,2,"runBatch"],[89,12,92,10],[89,13,92,11,"self"],[89,17,92,10],[89,19,92,17,"batch"],[89,24,92,10],[89,25,92,2],[90,0,93,1],[92,0,95,0],[92,11,95,9,"executeSql"],[92,21,95,0],[92,22,95,20,"self"],[92,26,95,0],[92,28,95,26,"sql"],[92,31,95,0],[92,33,95,31,"args"],[92,37,95,0],[92,39,95,37,"sqlCallback"],[92,50,95,0],[92,52,95,50,"sqlErrorCallback"],[92,68,95,0],[92,70,95,68],[93,0,96,2,"self"],[93,4,96,2,"self"],[93,8,96,6],[93,9,96,7,"_sqlQueue"],[93,18,96,2],[93,19,96,17,"push"],[93,23,96,2],[93,24,96,22],[93,28,96,26,"SQLTask"],[93,35,96,22],[93,36,96,34,"sql"],[93,39,96,22],[93,41,96,39,"args"],[93,45,96,22],[93,47,96,45,"sqlCallback"],[93,58,96,22],[93,60,96,58,"sqlErrorCallback"],[93,76,96,22],[93,77,96,2],[95,0,97,2],[95,8,97,6,"self"],[95,12,97,10],[95,13,97,11,"_runningTimeout"],[95,28,97,2],[95,30,97,28],[96,0,98,4],[97,0,99,3],[99,0,100,2,"self"],[99,4,100,2,"self"],[99,8,100,6],[99,9,100,7,"_runningTimeout"],[99,24,100,2],[99,27,100,25],[99,31,100,2],[100,0,101,2,"immediate"],[100,4,101,2,"immediate"],[100,13,101,11],[100,14,101,12],[100,26,101,24],[101,0,102,4,"self"],[101,6,102,4,"self"],[101,10,102,8],[101,11,102,9,"_runningTimeout"],[101,26,102,4],[101,29,102,27],[101,34,102,4],[102,0,103,4,"runAllSql"],[102,6,103,4,"runAllSql"],[102,15,103,13],[102,16,103,14,"self"],[102,20,103,13],[102,21,103,4],[103,0,104,3],[103,5,101,11],[103,6,101,2],[104,0,105,1],[106,0,107,0],[106,11,107,9,"WebSQLTransaction"],[106,28,107,0],[106,29,107,27,"websqlDatabase"],[106,43,107,0],[106,45,107,43],[107,0,108,2],[107,9,108,7,"_websqlDatabase"],[107,24,108,2],[107,27,108,25,"websqlDatabase"],[107,41,108,2],[108,0,109,2],[108,9,109,7,"_error"],[108,15,109,2],[108,18,109,16],[108,22,109,2],[109,0,110,2],[109,9,110,7,"_complete"],[109,18,110,2],[109,21,110,19],[109,26,110,2],[110,0,111,2],[110,9,111,7,"_runningTimeout"],[110,24,111,2],[110,27,111,25],[110,32,111,2],[111,0,112,2],[111,9,112,7,"_sqlQueue"],[111,18,112,2],[111,21,112,19],[111,25,112,23,"Queue"],[111,30,112,19],[111,32,112,2],[113,0,113,2],[113,8,113,6],[113,9,113,7,"websqlDatabase"],[113,23,113,21],[113,24,113,22,"_currentTask"],[113,36,113,7],[113,37,113,35,"readOnly"],[113,45,113,2],[113,47,113,45],[114,0,116,4],[114,11,116,9,"_sqlQueue"],[114,20,116,4],[114,21,116,19,"push"],[114,25,116,4],[114,26,116,24],[114,30,116,28,"SQLTask"],[114,37,116,24],[114,38,116,36],[114,46,116,24],[114,48,116,46],[114,50,116,24],[114,52,116,50,"noop"],[114,56,116,24],[114,58,116,56,"noop"],[114,62,116,24],[114,63,116,4],[115,0,117,3],[116,0,118,1],[118,0,120,0,"WebSQLTransaction"],[118,2,120,0,"WebSQLTransaction"],[118,19,120,17],[118,20,120,18,"prototype"],[118,29,120,0],[118,30,120,28,"executeSql"],[118,40,120,0],[118,43,120,41],[118,53,120,51,"sql"],[118,56,120,41],[118,58,120,56,"args"],[118,62,120,41],[118,64,120,62,"sqlCallback"],[118,75,120,41],[118,77,120,75,"sqlErrorCallback"],[118,93,120,41],[118,95,120,93],[119,0,121,2,"args"],[119,4,121,2,"args"],[119,8,121,6],[119,11,121,9,"Array"],[119,16,121,14],[119,17,121,15,"isArray"],[119,24,121,9],[119,25,121,23,"args"],[119,29,121,9],[119,33,121,31,"args"],[119,37,121,9],[119,40,121,38],[119,42,121,2],[120,0,122,2,"sqlCallback"],[120,4,122,2,"sqlCallback"],[120,15,122,13],[120,18,122,16],[120,25,122,23,"sqlCallback"],[120,36,122,16],[120,41,122,39],[120,51,122,16],[120,54,122,52,"sqlCallback"],[120,65,122,16],[120,68,122,66,"noop"],[120,72,122,2],[121,0,123,2,"sqlErrorCallback"],[121,4,123,2,"sqlErrorCallback"],[121,20,123,18],[121,23,123,21],[121,30,123,28,"sqlErrorCallback"],[121,46,123,21],[121,51,123,49],[121,61,123,21],[121,64,123,62,"sqlErrorCallback"],[121,80,123,21],[121,83,123,81,"errorUnhandled"],[121,97,123,2],[122,0,125,2,"executeSql"],[122,4,125,2,"executeSql"],[122,14,125,12],[122,15,125,13],[122,19,125,12],[122,21,125,19,"sql"],[122,24,125,12],[122,26,125,24,"args"],[122,30,125,12],[122,32,125,30,"sqlCallback"],[122,43,125,12],[122,45,125,43,"sqlErrorCallback"],[122,61,125,12],[122,62,125,2],[123,0,126,1],[123,3,120,0],[125,0,128,0,"WebSQLTransaction"],[125,2,128,0,"WebSQLTransaction"],[125,19,128,17],[125,20,128,18,"prototype"],[125,29,128,0],[125,30,128,28,"_checkDone"],[125,40,128,0],[125,43,128,41],[125,55,128,53],[126,0,129,2,"runAllSql"],[126,4,129,2,"runAllSql"],[126,13,129,11],[126,14,129,12],[126,18,129,11],[126,19,129,2],[127,0,130,1],[127,3,128,0],[129,0,132,0,"module"],[129,2,132,0,"module"],[129,8,132,6],[129,9,132,7,"exports"],[129,16,132,0],[129,19,132,17,"WebSQLTransaction"],[129,36,132,0]]},"type":"js/module"}]}